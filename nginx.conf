# Copyright (C) 2025  Henrique Almeida
# This file is part of WASudoku.
#
# WASudoku is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# WASudoku is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with WASudoku.  If not, see <https://www.gnu.org/licenses/>.

server {
    listen 80;
    server_name localhost;

    # Include the default mime.types file to correctly set Content-Type headers.
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Root directory for static files.
    root /usr/share/nginx/html;
    index index.html;

    # Define custom MIME type for WebAssembly files.
    types {
        application/wasm wasm;
    }

    # Compression settings for performance.
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript application/wasm image/svg+xml;

    # Main location block for the SPA.
    location /WASudoku/ {
        # Try to serve the requested file directly. If it's a directory,
        # try to serve its index file. If neither exists, fall back to
        # the main index.html to enable client-side routing.
        try_files $uri $uri/ /WASudoku/index.html;
    }

    # Redirect requests from the root to the application's base URL.
    location = / {
        return 301 /WASudoku/;
    }

    # Set long cache headers for versioned assets.
    location ~* ^/WASudoku/assets/.*\.(js|css|wasm|png|svg|ico)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
